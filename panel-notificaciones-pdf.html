<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel Admin - Notificaciones PDF</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gradient-to-br from-blue-500 to-purple-600 min-h-screen p-6">
  
  <div class="max-w-5xl mx-auto">
    <!-- Header -->
    <div class="bg-white rounded-xl shadow-2xl p-8 mb-6">
      <div class="flex justify-between items-center">
        <div>
          <h1 class="text-3xl font-bold text-gray-800">üìÑ Gesti√≥n de Notificaciones PDF</h1>
          <p class="text-gray-600 mt-2">Admin: <span id="adminEmail" class="font-semibold"></span></p>
        </div>
        <button id="logoutBtn" onclick="cerrarSesion()" class="hidden bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">
          Cerrar Sesi√≥n
        </button>
      </div>
      <div id="statusMessage" class="mt-4 hidden"></div>
    </div>

    <!-- Login Section -->
    <div id="loginSection" class="bg-white rounded-xl shadow-2xl p-8">
      <h2 class="text-2xl font-bold mb-6">üîê Iniciar Sesi√≥n</h2>
      <div class="space-y-4">
        <div>
          <label class="block text-gray-700 font-medium mb-2">Email</label>
          <input type="email" id="loginEmail" value="pabloperagon@gmail.com" 
                 class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none">
        </div>
        <div>
          <label class="block text-gray-700 font-medium mb-2">Contrase√±a</label>
          <input type="password" id="loginPassword" 
                 class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none">
        </div>
        <button onclick="iniciarSesion()" 
                class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-3 rounded-lg font-semibold hover:shadow-lg">
          Iniciar Sesi√≥n
        </button>
      </div>
    </div>

    <!-- Main Panel -->
    <div id="mainPanel" class="hidden space-y-6">
      
      <!-- Subir PDF -->
      <div class="bg-white rounded-xl shadow-2xl p-8">
        <h2 class="text-2xl font-bold mb-6">üì§ Subir PDF a un Negocio</h2>
        
        <div class="space-y-4">
          <div>
            <label class="block text-gray-700 font-medium mb-2">Buscar Negocio</label>
            <input type="text" id="buscarNegocio" placeholder="Escribe el nombre del negocio..." 
                   class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                   oninput="filtrarNegocios()">
          </div>

          <div>
            <label class="block text-gray-700 font-medium mb-2">Seleccionar Negocio</label>
            <select id="negocioSelect" 
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none">
              <option value="">Cargando negocios...</option>
            </select>
          </div>

          <div id="dropZonePdf" class="border-4 border-dashed border-blue-400 rounded-lg p-12 text-center cursor-pointer hover:bg-blue-50 transition">
            <input type="file" id="pdfInput" accept="application/pdf" class="hidden">
            <p class="text-xl font-semibold text-gray-700">üìÑ Arrastra un PDF aqu√≠ o haz clic</p>
            <p class="text-gray-500 mt-2">M√°ximo 10MB</p>
          </div>

          <div id="pdfPreview" class="hidden bg-gray-100 rounded-lg p-4">
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-3">
                <div class="bg-red-500 text-white p-3 rounded-lg">
                  <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z"/>
                  </svg>
                </div>
                <div>
                  <p class="font-semibold" id="pdfNombre"></p>
                  <p class="text-sm text-gray-600" id="pdfTamanio"></p>
                </div>
              </div>
              <button onclick="limpiarPdf()" class="text-red-500 hover:text-red-700">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>
            </div>
          </div>

          <button onclick="subirPdf()" id="subirPdfBtn" 
                  class="w-full bg-green-500 text-white py-3 rounded-lg font-semibold hover:bg-green-600 disabled:opacity-50">
            Subir PDF
          </button>
        </div>
      </div>

      <!-- Lista de Negocios con PDF -->
      <div class="bg-white rounded-xl shadow-2xl p-8">
        <h2 class="text-2xl font-bold mb-6">üìã Negocios con Notificaciones</h2>
        <div id="negociosConPdfGrid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
      </div>

    </div>
  </div>

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl p-8 text-center">
      <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-blue-500 mx-auto mb-4"></div>
      <p class="text-lg font-semibold">Subiendo PDF...</p>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://kmxacmsqybtwbebqhwnu.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtteGFjbXNxeWJ0d2JlYnFod251Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEyMzc4NjQsImV4cCI6MjA3NjgxMzg2NH0.Tjpw2BFrIZfBf8LOf4nBKq7s551lrNSsqiIXKSgz_E4'
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
    let pdfSeleccionado = null
    let todosLosNegocios = []

    function mostrarMensaje(msg, tipo) {
      const el = document.getElementById('statusMessage')
      el.className = `p-4 rounded-lg ${tipo === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`
      el.textContent = msg
      el.classList.remove('hidden')
      setTimeout(() => el.classList.add('hidden'), 5000)
    }

    async function iniciarSesion() {
      const email = document.getElementById('loginEmail').value
      const password = document.getElementById('loginPassword').value
      
      try {
        const { data, error } = await supabase.auth.signInWithPassword({ email, password })
        if (error) throw error
        
        document.getElementById('adminEmail').textContent = data.user.email
        document.getElementById('loginSection').classList.add('hidden')
        document.getElementById('mainPanel').classList.remove('hidden')
        document.getElementById('logoutBtn').classList.remove('hidden')
        
        await cargarNegocios()
        await cargarNegociosConPdf()
        mostrarMensaje('Sesi√≥n iniciada', 'success')
      } catch (error) {
        mostrarMensaje('Error: ' + error.message, 'error')
      }
    }

    async function cerrarSesion() {
      await supabase.auth.signOut()
      location.reload()
    }

    async function cargarNegocios() {
      const { data } = await supabase
        .from('negocios')
        .select('id, nombre, pueblos!inner(nombre)')
        .eq('activo', true)
        .order('nombre')

      todosLosNegocios = data || []
      mostrarNegocios(todosLosNegocios)
    }

    function mostrarNegocios(negocios) {
      const select = document.getElementById('negocioSelect')
      select.innerHTML = '<option value="">Selecciona un negocio...</option>' +
        negocios.map(n => `<option value="${n.id}">${n.nombre} - ${n.pueblos.nombre}</option>`).join('')
    }

    function filtrarNegocios() {
      const texto = document.getElementById('buscarNegocio').value.toLowerCase()
      const filtrados = todosLosNegocios.filter(n => 
        n.nombre.toLowerCase().includes(texto) || 
        n.pueblos.nombre.toLowerCase().includes(texto)
      )
      mostrarNegocios(filtrados)
    }

    // Drag & Drop
    const dropZone = document.getElementById('dropZonePdf')
    const input = document.getElementById('pdfInput')

    dropZone.onclick = () => input.click()
    dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('bg-blue-100') }
    dropZone.ondragleave = () => dropZone.classList.remove('bg-blue-100')
    dropZone.ondrop = (e) => {
      e.preventDefault()
      dropZone.classList.remove('bg-blue-100')
      if (e.dataTransfer.files[0]?.type === 'application/pdf') {
        handlePdf(e.dataTransfer.files[0])
      } else {
        mostrarMensaje('Solo se permiten archivos PDF', 'error')
      }
    }
    input.onchange = (e) => {
      if (e.target.files[0]) handlePdf(e.target.files[0])
    }

    function handlePdf(file) {
      if (file.size > 10 * 1024 * 1024) {
        mostrarMensaje('El PDF no debe superar 10MB', 'error')
        return
      }

      pdfSeleccionado = file
      document.getElementById('pdfPreview').classList.remove('hidden')
      document.getElementById('pdfNombre').textContent = file.name
      document.getElementById('pdfTamanio').textContent = (file.size / 1024 / 1024).toFixed(2) + ' MB'
    }

    function limpiarPdf() {
      pdfSeleccionado = null
      document.getElementById('pdfPreview').classList.add('hidden')
      document.getElementById('pdfInput').value = ''
    }

    async function subirPdf() {
      const negocioId = document.getElementById('negocioSelect').value
      
      if (!negocioId) {
        mostrarMensaje('Selecciona un negocio', 'error')
        return
      }
      
      if (!pdfSeleccionado) {
        mostrarMensaje('Selecciona un PDF', 'error')
        return
      }

      document.getElementById('loadingOverlay').classList.remove('hidden')
      const btn = document.getElementById('subirPdfBtn')
      btn.disabled = true

      try {
        // Subir PDF a Storage
        const timestamp = Date.now()
        const path = `notificaciones/${negocioId}/${timestamp}_${pdfSeleccionado.name}`

        const { error: uploadError } = await supabase.storage
          .from('notificaciones-pdfs')
          .upload(path, pdfSeleccionado, { upsert: true })

        if (uploadError) throw uploadError

        // Obtener URL p√∫blica
        const { data: { publicUrl } } = supabase.storage
          .from('notificaciones-pdfs')
          .getPublicUrl(path)

        // Actualizar negocio con la URL
        const { error: updateError } = await supabase
          .from('negocios')
          .update({ notificacion_pdf_url: publicUrl })
          .eq('id', negocioId)

        if (updateError) throw updateError

        mostrarMensaje('‚úÖ PDF subido correctamente!', 'success')
        limpiarPdf()
        document.getElementById('negocioSelect').value = ''
        document.getElementById('buscarNegocio').value = ''
        await cargarNegociosConPdf()

      } catch (error) {
        mostrarMensaje('Error: ' + error.message, 'error')
      } finally {
        document.getElementById('loadingOverlay').classList.add('hidden')
        btn.disabled = false
      }
    }

    async function cargarNegociosConPdf() {
      const { data } = await supabase
        .from('negocios')
        .select('id, nombre, notificacion_pdf_url, pueblos!inner(nombre)')
        .not('notificacion_pdf_url', 'is', null)
        .order('nombre')

      const grid = document.getElementById('negociosConPdfGrid')
      
      if (!data || data.length === 0) {
        grid.innerHTML = '<p class="col-span-full text-gray-500 text-center">No hay negocios con notificaciones</p>'
        return
      }

      grid.innerHTML = data.map(n => `
        <div class="border-2 border-gray-200 rounded-lg p-4 hover:border-blue-400 transition">
          <div class="flex items-start justify-between">
            <div class="flex-1">
              <h3 class="font-bold text-lg">${n.nombre}</h3>
              <p class="text-gray-600 text-sm">${n.pueblos.nombre}</p>
              <a href="${n.notificacion_pdf_url}" target="_blank" 
                 class="inline-block mt-2 text-blue-500 hover:text-blue-700 text-sm flex items-center">
                <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5z"/>
                  <path d="M5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z"/>
                </svg>
                Ver PDF
              </a>
            </div>
            <button onclick="eliminarPdf(${n.id})" 
                    class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 text-sm">
              Eliminar
            </button>
          </div>
        </div>
      `).join('')
    }

    async function eliminarPdf(negocioId) {
      if (!confirm('¬øEliminar el PDF de notificaci√≥n de este negocio?')) return

      try {
        const { error } = await supabase
          .from('negocios')
          .update({ notificacion_pdf_url: null })
          .eq('id', negocioId)

        if (error) throw error

        mostrarMensaje('PDF eliminado correctamente', 'success')
        await cargarNegociosConPdf()
      } catch (error) {
        mostrarMensaje('Error: ' + error.message, 'error')
      }
    }
  </script>
</body>
</html>