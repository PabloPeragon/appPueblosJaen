<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel Admin - Gesti√≥n de Negocios</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .drag-over { background-color: #e0e7ff !important; border-color: #6366f1 !important; }
  </style>
</head>
<body class="bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 min-h-screen p-6">
  
  <div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="bg-white rounded-2xl shadow-2xl p-8 mb-6">
      <div class="flex justify-between items-center">
        <div>
          <h1 class="text-4xl font-bold text-gray-800">üè¢ Gesti√≥n Completa de Negocios</h1>
          <p class="text-gray-600 mt-2">Admin: <span id="adminEmail" class="font-semibold text-indigo-600"></span></p>
        </div>
        <button id="logoutBtn" onclick="cerrarSesion()" class="hidden bg-red-500 text-white px-6 py-3 rounded-lg hover:bg-red-600 font-semibold shadow-lg">
          Cerrar Sesi√≥n
        </button>
      </div>
      <div id="statusMessage" class="mt-4 hidden"></div>
    </div>

    <!-- Login Section -->
    <div id="loginSection" class="bg-white rounded-2xl shadow-2xl p-8">
      <h2 class="text-3xl font-bold mb-6">üîê Iniciar Sesi√≥n</h2>
      <div class="space-y-4">
        <div>
          <label class="block text-gray-700 font-medium mb-2">Email</label>
          <input type="email" id="loginEmail" value="pabloperagon@gmail.com" 
                 class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none">
        </div>
        <div>
          <label class="block text-gray-700 font-medium mb-2">Contrase√±a</label>
          <input type="password" id="loginPassword" 
                 class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none">
        </div>
        <button onclick="iniciarSesion()" 
                class="w-full bg-gradient-to-r from-indigo-500 to-purple-600 text-white py-4 rounded-lg font-bold text-lg hover:shadow-2xl transform hover:scale-105 transition">
          Iniciar Sesi√≥n
        </button>
      </div>
    </div>

    <!-- Main Panel -->
    <div id="mainPanel" class="hidden space-y-6">
      
      <!-- B√∫squeda Global -->
      <div class="bg-white rounded-2xl shadow-lg p-6">
        <div class="relative">
          <input type="text" id="buscarNegocioGlobal" placeholder="üîç Buscar negocio por nombre o pueblo..." 
                 class="w-full px-6 py-4 text-lg border-2 border-gray-300 rounded-xl focus:border-indigo-500 focus:outline-none pl-12"
                 oninput="filtrarNegociosGlobal()">
          <svg class="w-6 h-6 absolute left-4 top-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
          </svg>
        </div>
      </div>

      <!-- Tabs -->
      <div class="bg-white rounded-2xl shadow-lg p-4">
        <div class="flex flex-wrap gap-2">
          <button onclick="cambiarTab('crear')" class="tab-btn active flex-1 min-w-fit px-6 py-4 rounded-xl font-bold text-sm transition hover:shadow-lg">
            ‚ûï Crear Negocio
          </button>
          <button onclick="cambiarTab('lista')" class="tab-btn flex-1 min-w-fit px-6 py-4 rounded-xl font-bold text-sm transition hover:shadow-lg">
            üìã Gestionar Negocios
          </button>
          <button onclick="cambiarTab('imagen')" class="tab-btn flex-1 min-w-fit px-6 py-4 rounded-xl font-bold text-sm transition hover:shadow-lg">
            üñºÔ∏è Imagen Principal
          </button>
          <button onclick="cambiarTab('galeria')" class="tab-btn flex-1 min-w-fit px-6 py-4 rounded-xl font-bold text-sm transition hover:shadow-lg">
            üì∏ Galer√≠a Fotos
          </button>
          <button onclick="cambiarTab('pdf')" class="tab-btn flex-1 min-w-fit px-6 py-4 rounded-xl font-bold text-sm transition hover:shadow-lg">
            üìÑ PDF Notificaci√≥n
          </button>
        </div>
      </div>

      <!-- Tab: Crear Negocio -->
      <div id="crearTab" class="tab-content active bg-white rounded-2xl shadow-2xl p-8">
        <h2 class="text-3xl font-bold mb-6">‚ûï Crear Nuevo Negocio</h2>
        
        <div class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-gray-700 font-medium mb-2">Pueblo *</label>
              <select id="puebloNuevo" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none">
                <option value="">Cargando...</option>
              </select>
            </div>
            <div>
              <label class="block text-gray-700 font-medium mb-2">Categor√≠a *</label>
              <select id="categoriaNuevo" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none">
                <option value="">Cargando...</option>
              </select>
            </div>
          </div>

          <div>
            <label class="block text-gray-700 font-medium mb-2">Nombre del Negocio *</label>
            <input type="text" id="nombreNuevo" placeholder="Ej: Restaurante El Olivo" 
                   class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none">
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-gray-700 font-medium mb-2">Email</label>
              <input type="email" id="emailNuevo" placeholder="contacto@negocio.com"
                     class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none">
            </div>
            <div>
              <label class="block text-gray-700 font-medium mb-2">Tel√©fono</label>
              <input type="tel" id="telefonoNuevo" placeholder="953 123 456"
                     class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none">
            </div>
          </div>

          <div>
            <label class="block text-gray-700 font-medium mb-2">Direcci√≥n</label>
            <input type="text" id="direccionNuevo" placeholder="Calle Mayor, 10"
                   class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none">
          </div>

          <div>
            <label class="block text-gray-700 font-medium mb-2">Descripci√≥n</label>
            <textarea id="descripcionNuevo" rows="3" placeholder="Describe el negocio..."
                      class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none"></textarea>
          </div>

          <button onclick="crearNegocio()" id="crearNegocioBtn"
                  class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white py-4 rounded-lg font-bold text-lg hover:shadow-2xl transform hover:scale-105 transition">
            Crear Negocio
          </button>
        </div>
      </div>

      <!-- Tab: Lista Negocios -->
      <div id="listaTab" class="tab-content bg-white rounded-2xl shadow-2xl p-8">
        <h2 class="text-3xl font-bold mb-6">üìã Todos los Negocios</h2>
        <div id="negociosGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
      </div>

      <!-- Tab: Imagen Principal -->
      <div id="imagenTab" class="tab-content bg-white rounded-2xl shadow-2xl p-8">
        <h2 class="text-3xl font-bold mb-6">üñºÔ∏è Subir Imagen Principal</h2>
        
        <div class="space-y-6">
          <div>
            <label class="block text-gray-700 font-medium mb-2">Seleccionar Negocio</label>
            <select id="negocioImagenSelect" onchange="cargarImagenActual()" 
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none">
              <option value="">Selecciona un negocio...</option>
            </select>
          </div>

          <div id="imagenActualContainer" class="hidden bg-gray-100 rounded-lg p-6">
            <h3 class="font-bold text-lg mb-4">Imagen Actual:</h3>
            <img id="imagenActual" src="" alt="Imagen actual" class="max-w-xs rounded-lg shadow-lg">
          </div>

          <div id="dropZoneImagen" class="border-4 border-dashed border-indigo-400 rounded-xl p-16 text-center cursor-pointer hover:bg-indigo-50 transition">
            <input type="file" id="imagenInput" accept="image/*" class="hidden">
            <svg class="w-16 h-16 mx-auto text-indigo-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
            <p class="text-xl font-semibold text-gray-700">Arrastra una imagen o haz clic</p>
            <p class="text-gray-500 mt-2">JPG, PNG o WEBP - M√°ximo 5MB</p>
          </div>

          <div id="imagenPreview" class="hidden">
            <img id="imagenPreviewImg" src="" alt="Preview" class="max-w-xs rounded-lg shadow-lg mx-auto">
          </div>

          <button onclick="subirImagenPrincipal()" id="subirImagenBtn" class="hidden w-full bg-blue-500 text-white py-4 rounded-lg font-bold text-lg hover:bg-blue-600">
            Subir Imagen Principal
          </button>
        </div>
      </div>

      <!-- Tab: Galer√≠a -->
      <div id="galeriaTab" class="tab-content bg-white rounded-2xl shadow-2xl p-8">
        <h2 class="text-3xl font-bold mb-6">üì∏ Gestionar Galer√≠a de Fotos</h2>
        
        <div class="space-y-6">
          <div>
            <label class="block text-gray-700 font-medium mb-2">Seleccionar Negocio</label>
            <select id="negocioGaleriaSelect" onchange="cargarGaleriaNegocio()" 
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none">
              <option value="">Selecciona un negocio...</option>
            </select>
          </div>

          <div id="dropZoneGaleria" class="border-4 border-dashed border-purple-400 rounded-xl p-16 text-center cursor-pointer hover:bg-purple-50 transition">
            <input type="file" id="galeriaInput" accept="image/*" multiple class="hidden">
            <svg class="w-16 h-16 mx-auto text-purple-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
            <p class="text-xl font-semibold text-gray-700">Arrastra m√∫ltiples fotos</p>
            <p class="text-gray-500 mt-2">Primera foto = Portada</p>
          </div>

          <div id="galeriaPreview" class="grid grid-cols-3 md:grid-cols-4 gap-4"></div>

          <button onclick="subirGaleria()" id="subirGaleriaBtn" class="hidden w-full bg-purple-500 text-white py-4 rounded-lg font-bold text-lg hover:bg-purple-600">
            Subir Fotos a Galer√≠a
          </button>

          <hr class="my-8">

          <h3 class="text-xl font-bold">üñºÔ∏è Galer√≠a Actual</h3>
          <div id="galeriaActualGrid" class="grid grid-cols-3 md:grid-cols-4 gap-4"></div>
        </div>
      </div>

      <!-- Tab: PDF -->
      <div id="pdfTab" class="tab-content bg-white rounded-2xl shadow-2xl p-8">
        <h2 class="text-3xl font-bold mb-6">üìÑ Gestionar PDF de Notificaci√≥n</h2>
        
        <div class="space-y-6">
          <div>
            <label class="block text-gray-700 font-medium mb-2">Seleccionar Negocio</label>
            <select id="negocioPdfSelect" onchange="cargarPdfActual()" 
                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none">
              <option value="">Selecciona un negocio...</option>
            </select>
          </div>

          <div id="pdfActualContainer" class="hidden bg-gray-100 rounded-lg p-6">
            <h3 class="font-bold text-lg mb-4">PDF Actual:</h3>
            <a id="pdfActualLink" href="#" target="_blank" class="inline-flex items-center px-6 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600">
              <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z"/>
              </svg>
              Ver PDF Actual
            </a>
          </div>

          <div id="dropZonePdf" class="border-4 border-dashed border-red-400 rounded-xl p-16 text-center cursor-pointer hover:bg-red-50 transition">
            <input type="file" id="pdfInput" accept="application/pdf" class="hidden">
            <svg class="w-16 h-16 mx-auto text-red-400 mb-4" fill="currentColor" viewBox="0 0 20 20">
              <path d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z"/>
            </svg>
            <p class="text-xl font-semibold text-gray-700">Arrastra un PDF</p>
            <p class="text-gray-500 mt-2">M√°ximo 10MB</p>
          </div>

          <div id="pdfPreview" class="hidden bg-gray-100 rounded-lg p-4">
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-3">
                <div class="bg-red-500 text-white p-3 rounded-lg">
                  <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z"/>
                  </svg>
                </div>
                <div>
                  <p class="font-semibold" id="pdfNombre"></p>
                  <p class="text-sm text-gray-600" id="pdfTamanio"></p>
                </div>
              </div>
              <button onclick="limpiarPdf()" class="text-red-500 hover:text-red-700">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>
            </div>
          </div>

          <button onclick="subirPdf()" id="subirPdfBtn" class="hidden w-full bg-red-500 text-white py-4 rounded-lg font-bold text-lg hover:bg-red-600">
            Subir PDF de Notificaci√≥n
          </button>
        </div>
      </div>

    </div>
  </div>

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-8 text-center">
      <div class="animate-spin rounded-full h-20 w-20 border-b-4 border-indigo-500 mx-auto mb-4"></div>
      <p class="text-xl font-semibold" id="loadingText">Cargando...</p>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://kmxacmsqybtwbebqhwnu.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtteGFjbXNxeWJ0d2JlYnFod251Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEyMzc4NjQsImV4cCI6MjA3NjgxMzg2NH0.Tjpw2BFrIZfBf8LOf4nBKq7s551lrNSsqiIXKSgz_E4'
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
    
    let todosLosNegocios = []
    let imagenSeleccionada = null
    let pdfSeleccionado = null
    let fotosGaleria = []

    function mostrarMensaje(msg, tipo) {
      const el = document.getElementById('statusMessage')
      el.className = `p-4 rounded-lg ${tipo === 'success' ? 'bg-green-100 text-green-800 border-2 border-green-300' : 'bg-red-100 text-red-800 border-2 border-red-300'}`
      el.innerHTML = `<strong>${tipo === 'success' ? '‚úÖ' : '‚ùå'}</strong> ${msg}`
      el.classList.remove('hidden')
      setTimeout(() => el.classList.add('hidden'), 5000)
    }

    function showLoading(text = 'Cargando...') {
      document.getElementById('loadingText').textContent = text
      document.getElementById('loadingOverlay').classList.remove('hidden')
    }

    function hideLoading() {
      document.getElementById('loadingOverlay').classList.add('hidden')
    }

    async function iniciarSesion() {
      const email = document.getElementById('loginEmail').value
      const password = document.getElementById('loginPassword').value
      
      try {
        const { data, error } = await supabase.auth.signInWithPassword({ email, password })
        if (error) throw error
        
        document.getElementById('adminEmail').textContent = data.user.email
        document.getElementById('loginSection').classList.add('hidden')
        document.getElementById('mainPanel').classList.remove('hidden')
        document.getElementById('logoutBtn').classList.remove('hidden')
        
        await Promise.all([
          cargarPueblos(),
          cargarCategorias(),
          cargarNegocios()
        ])
        
        mostrarMensaje('Sesi√≥n iniciada correctamente', 'success')
      } catch (error) {
        mostrarMensaje('Error: ' + error.message, 'error')
      }
    }

    async function cerrarSesion() {
      await supabase.auth.signOut()
      location.reload()
    }

    async function cargarPueblos() {
      const { data } = await supabase.from('pueblos').select('id, nombre').order('nombre')
      const select = document.getElementById('puebloNuevo')
      select.innerHTML = '<option value="">Selecciona un pueblo...</option>' +
        (data || []).map(p => `<option value="${p.id}">${p.nombre}</option>`).join('')
    }

    async function cargarCategorias() {
      const { data } = await supabase.from('categorias_negocios').select('id, nombre').order('nombre')
      const select = document.getElementById('categoriaNuevo')
      select.innerHTML = '<option value="">Selecciona una categor√≠a...</option>' +
        (data || []).map(c => `<option value="${c.id}">${c.nombre}</option>`).join('')
    }

    async function cargarNegocios() {
      const { data } = await supabase
        .from('negocios')
        .select('*, pueblos!inner(nombre), categorias_negocios(nombre)')
        .order('nombre')
      
      todosLosNegocios = data || []
      mostrarNegocios(todosLosNegocios)
      llenarSelectsNegocios(todosLosNegocios)
    }

    function llenarSelectsNegocios(negocios) {
      const selects = ['negocioImagenSelect', 'negocioGaleriaSelect', 'negocioPdfSelect']
      selects.forEach(selectId => {
        const select = document.getElementById(selectId)
        select.innerHTML = '<option value="">Selecciona un negocio...</option>' +
          negocios.map(n => `<option value="${n.id}">${n.nombre} - ${n.pueblos.nombre}</option>`).join('')
      })
    }

    function filtrarNegociosGlobal() {
      const texto = document.getElementById('buscarNegocioGlobal').value.toLowerCase()
      const filtrados = todosLosNegocios.filter(n => 
        n.nombre.toLowerCase().includes(texto) || 
        n.pueblos.nombre.toLowerCase().includes(texto)
      )
      mostrarNegocios(filtrados)
      llenarSelectsNegocios(filtrados)
    }

    function mostrarNegocios(negocios) {
      const grid = document.getElementById('negociosGrid')
      
      if (negocios.length === 0) {
        grid.innerHTML = '<p class="col-span-full text-center text-gray-500 py-12">No se encontraron negocios</p>'
        return
      }

      grid.innerHTML = negocios.map(n => `
        <div class="border-2 border-gray-200 rounded-xl p-6 hover:border-indigo-400 hover:shadow-xl transition">
          ${n.imagen_principal_url ? `
            <img src="${n.imagen_principal_url}" alt="${n.nombre}" class="w-full h-40 object-cover rounded-lg mb-4">
          ` : `
            <div class="w-full h-40 bg-gradient-to-br from-gray-100 to-gray-200 rounded-lg mb-4 flex items-center justify-center">
              <svg class="w-16 h-16 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
              </svg>
            </div>
          `}
          <h3 class="font-bold text-lg mb-2">${n.nombre}</h3>
          <p class="text-sm text-gray-600 mb-1">${n.pueblos.nombre}</p>
          ${n.categorias_negocios ? `<p class="text-xs text-indigo-600 font-semibold">${n.categorias_negocios.nombre}</p>` : ''}
          
          <div class="flex gap-2 mt-4">
            ${n.imagen_principal_url ? '<span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full font-semibold">üñºÔ∏è IMG</span>' : ''}
            ${n.notificacion_pdf_url ? '<span class="px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full font-semibold">üìÑ PDF</span>' : ''}
            ${n.verificado ? '<span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full font-semibold">‚úì</span>' : ''}
          </div>
        </div>
      `).join('')
    }

    async function crearNegocio() {
      const puebloId = document.getElementById('puebloNuevo').value
      const categoriaId = document.getElementById('categoriaNuevo').value
      const nombre = document.getElementById('nombreNuevo').value
      const email = document.getElementById('emailNuevo').value
      const telefono = document.getElementById('telefonoNuevo').value
      const direccion = document.getElementById('direccionNuevo').value
      const descripcion = document.getElementById('descripcionNuevo').value

      if (!puebloId || !nombre) {
        mostrarMensaje('Completa los campos obligatorios', 'error')
        return
      }

      const btn = document.getElementById('crearNegocioBtn')
      btn.disabled = true
      btn.textContent = 'Creando...'

      try {
        const { error } = await supabase.from('negocios').insert({
          pueblo_id: parseInt(puebloId),
          categoria_id: categoriaId ? parseInt(categoriaId) : null,
          nombre,
          email: email || null,
          telefono: telefono || null,
          direccion: direccion || null,
          descripcion: descripcion || null,
          activo: true,
          propietario_email: 'pabloperagon@gmail.com'
        })

        if (error) throw error
        
        mostrarMensaje(`‚úÖ Negocio "${nombre}" creado correctamente!`, 'success')
        
        // Limpiar formulario
        document.getElementById('nombreNuevo').value = ''
        document.getElementById('emailNuevo').value = ''
        document.getElementById('telefonoNuevo').value = ''
        document.getElementById('direccionNuevo').value = ''
        document.getElementById('descripcionNuevo').value = ''
        
        await cargarNegocios()
      } catch (error) {
        mostrarMensaje('Error: ' + error.message, 'error')
      } finally {
        btn.disabled = false
        btn.textContent = 'Crear Negocio'
      }
    }

    // Tabs
    function cambiarTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(b => {
        b.classList.remove('active', 'bg-indigo-500', 'text-white', 'shadow-lg')
        b.classList.add('bg-gray-100', 'text-gray-700')
      })
      event.target.classList.add('active', 'bg-indigo-500', 'text-white', 'shadow-lg')
      event.target.classList.remove('bg-gray-100', 'text-gray-700')
      
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'))
      document.getElementById(tab + 'Tab').classList.add('active')
    }

    // Drag & Drop - Imagen Principal
    const dropZoneImagen = document.getElementById('dropZoneImagen')
    const imagenInput = document.getElementById('imagenInput')

    dropZoneImagen.onclick = () => imagenInput.click()
    dropZoneImagen.ondragover = (e) => { e.preventDefault(); dropZoneImagen.classList.add('drag-over') }
    dropZoneImagen.ondragleave = () => dropZoneImagen.classList.remove('drag-over')
    dropZoneImagen.ondrop = (e) => {
      e.preventDefault()
      dropZoneImagen.classList.remove('drag-over')
      if (e.dataTransfer.files[0]?.type.startsWith('image/')) {
        handleImagen(e.dataTransfer.files[0])
      }
    }
    imagenInput.onchange = (e) => { if (e.target.files[0]) handleImagen(e.target.files[0]) }

    function handleImagen(file) {
      if (file.size > 5 * 1024 * 1024) {
        mostrarMensaje('La imagen no debe superar 5MB', 'error')
        return
      }

      imagenSeleccionada = file
      const preview = document.getElementById('imagenPreview')
      const img = document.getElementById('imagenPreviewImg')
      const reader = new FileReader()
      
      reader.onload = (e) => {
        img.src = e.target.result
        preview.classList.remove('hidden')
        document.getElementById('subirImagenBtn').classList.remove('hidden')
      }
      reader.readAsDataURL(file)
    }

    async function cargarImagenActual() {
      const negocioId = document.getElementById('negocioImagenSelect').value
      if (!negocioId) return

      const negocio = todosLosNegocios.find(n => n.id == negocioId)
      const container = document.getElementById('imagenActualContainer')
      
      if (negocio?.imagen_principal_url) {
        document.getElementById('imagenActual').src = negocio.imagen_principal_url
        container.classList.remove('hidden')
      } else {
        container.classList.add('hidden')
      }
    }

    async function subirImagenPrincipal() {
      const negocioId = document.getElementById('negocioImagenSelect').value
      
      if (!negocioId || !imagenSeleccionada) {
        mostrarMensaje('Selecciona un negocio y una imagen', 'error')
        return
      }

      showLoading('Subiendo imagen...')

      try {
        const ext = imagenSeleccionada.name.split('.').pop()
        const path = `negocios/${negocioId}/logo_${Date.now()}.${ext}`

        const { error: uploadError } = await supabase.storage
          .from('imagenes-negocios')
          .upload(path, imagenSeleccionada, { upsert: true })

        if (uploadError) throw uploadError

        const { data: { publicUrl } } = supabase.storage.from('imagenes-negocios').getPublicUrl(path)

        const { error: updateError } = await supabase
          .from('negocios')
          .update({ imagen_principal_url: publicUrl })
          .eq('id', negocioId)

        if (updateError) throw updateError

        mostrarMensaje('‚úÖ Imagen subida correctamente!', 'success')
        imagenSeleccionada = null
        document.getElementById('imagenPreview').classList.add('hidden')
        document.getElementById('subirImagenBtn').classList.add('hidden')
        document.getElementById('imagenInput').value = ''
        await cargarNegocios()
        await cargarImagenActual()

      } catch (error) {
        mostrarMensaje('Error: ' + error.message, 'error')
      } finally {
        hideLoading()
      }
    }

    // Drag & Drop - PDF
    const dropZonePdf = document.getElementById('dropZonePdf')
    const pdfInput = document.getElementById('pdfInput')

    dropZonePdf.onclick = () => pdfInput.click()
    dropZonePdf.ondragover = (e) => { e.preventDefault(); dropZonePdf.classList.add('drag-over') }
    dropZonePdf.ondragleave = () => dropZonePdf.classList.remove('drag-over')
    dropZonePdf.ondrop = (e) => {
      e.preventDefault()
      dropZonePdf.classList.remove('drag-over')
      if (e.dataTransfer.files[0]?.type === 'application/pdf') {
        handlePdf(e.dataTransfer.files[0])
      }
    }
    pdfInput.onchange = (e) => { if (e.target.files[0]) handlePdf(e.target.files[0]) }

    function handlePdf(file) {
      if (file.size > 10 * 1024 * 1024) {
        mostrarMensaje('El PDF no debe superar 10MB', 'error')
        return
      }

      pdfSeleccionado = file
      document.getElementById('pdfPreview').classList.remove('hidden')
      document.getElementById('pdfNombre').textContent = file.name
      document.getElementById('pdfTamanio').textContent = (file.size / 1024 / 1024).toFixed(2) + ' MB'
      document.getElementById('subirPdfBtn').classList.remove('hidden')
    }

    function limpiarPdf() {
      pdfSeleccionado = null
      document.getElementById('pdfPreview').classList.add('hidden')
      document.getElementById('pdfInput').value = ''
      document.getElementById('subirPdfBtn').classList.add('hidden')
    }

    async function cargarPdfActual() {
      const negocioId = document.getElementById('negocioPdfSelect').value
      if (!negocioId) return

      const negocio = todosLosNegocios.find(n => n.id == negocioId)
      const container = document.getElementById('pdfActualContainer')
      
      if (negocio?.notificacion_pdf_url) {
        document.getElementById('pdfActualLink').href = negocio.notificacion_pdf_url
        container.classList.remove('hidden')
      } else {
        container.classList.add('hidden')
      }
    }

    async function subirPdf() {
      const negocioId = document.getElementById('negocioPdfSelect').value
      
      if (!negocioId || !pdfSeleccionado) {
        mostrarMensaje('Selecciona un negocio y un PDF', 'error')
        return
      }

      showLoading('Subiendo PDF...')

      try {
        const path = `notificaciones/${negocioId}/${Date.now()}_${pdfSeleccionado.name}`

        const { error: uploadError } = await supabase.storage
          .from('notificaciones-pdfs')
          .upload(path, pdfSeleccionado, { upsert: true })

        if (uploadError) throw uploadError

        const { data: { publicUrl } } = supabase.storage.from('notificaciones-pdfs').getPublicUrl(path)

        const { error: updateError } = await supabase
          .from('negocios')
          .update({ notificacion_pdf_url: publicUrl })
          .eq('id', negocioId)

        if (updateError) throw updateError

        mostrarMensaje('‚úÖ PDF subido correctamente!', 'success')
        limpiarPdf()
        await cargarNegocios()
        await cargarPdfActual()

      } catch (error) {
        mostrarMensaje('Error: ' + error.message, 'error')
      } finally {
        hideLoading()
      }
    }

    // Drag & Drop - Galer√≠a
    const dropZoneGaleria = document.getElementById('dropZoneGaleria')
    const galeriaInput = document.getElementById('galeriaInput')

    dropZoneGaleria.onclick = () => galeriaInput.click()
    dropZoneGaleria.ondragover = (e) => { e.preventDefault(); dropZoneGaleria.classList.add('drag-over') }
    dropZoneGaleria.ondragleave = () => dropZoneGaleria.classList.remove('drag-over')
    dropZoneGaleria.ondrop = (e) => {
      e.preventDefault()
      dropZoneGaleria.classList.remove('drag-over')
      handleGaleriaFiles(e.dataTransfer.files)
    }
    galeriaInput.onchange = (e) => handleGaleriaFiles(e.target.files)

    function handleGaleriaFiles(files) {
      fotosGaleria = Array.from(files).filter(f => f.type.startsWith('image/'))
      mostrarPreviewGaleria()
    }

    function mostrarPreviewGaleria() {
      const grid = document.getElementById('galeriaPreview')
      const btn = document.getElementById('subirGaleriaBtn')

      if (fotosGaleria.length === 0) {
        grid.innerHTML = ''
        btn.classList.add('hidden')
        return
      }

      btn.classList.remove('hidden')
      grid.innerHTML = fotosGaleria.map((f, i) => {
        const url = URL.createObjectURL(f)
        return `
          <div class="relative group">
            <img src="${url}" class="w-full h-32 object-cover rounded-lg">
            ${i === 0 ? '<span class="absolute top-2 left-2 bg-yellow-400 text-xs px-2 py-1 rounded font-bold">PORTADA</span>' : ''}
            <button onclick="eliminarFotoPreview(${i})" class="absolute top-2 right-2 bg-red-500 text-white w-8 h-8 rounded-full opacity-0 group-hover:opacity-100 transition">√ó</button>
          </div>
        `
      }).join('')
    }

    function eliminarFotoPreview(index) {
      fotosGaleria.splice(index, 1)
      mostrarPreviewGaleria()
    }

    async function subirGaleria() {
      const negocioId = document.getElementById('negocioGaleriaSelect').value
      
      if (!negocioId || fotosGaleria.length === 0) {
        mostrarMensaje('Selecciona un negocio y fotos', 'error')
        return
      }

      showLoading(`Subiendo ${fotosGaleria.length} fotos...`)

      try {
        for (let i = 0; i < fotosGaleria.length; i++) {
          const file = fotosGaleria[i]
          const ext = file.name.split('.').pop()
          const path = `negocios/${negocioId}/galeria_${Date.now()}_${i}.${ext}`

          const { error: uploadError } = await supabase.storage
            .from('fotos-negocios')
            .upload(path, file, { upsert: true })

          if (uploadError) throw uploadError

          const { data: { publicUrl } } = supabase.storage.from('fotos-negocios').getPublicUrl(path)

          const { error: dbError } = await supabase.from('fotos_negocios').insert({
            negocio_id: parseInt(negocioId),
            url_foto: publicUrl,
            es_portada: i === 0,
            es_logo: false,
            orden: i
          })

          if (dbError) throw dbError
        }

        mostrarMensaje(`‚úÖ ${fotosGaleria.length} fotos subidas correctamente!`, 'success')
        fotosGaleria = []
        document.getElementById('galeriaPreview').innerHTML = ''
        document.getElementById('subirGaleriaBtn').classList.add('hidden')
        document.getElementById('galeriaInput').value = ''
        await cargarGaleriaNegocio()

      } catch (error) {
        mostrarMensaje('Error: ' + error.message, 'error')
      } finally {
        hideLoading()
      }
    }

    async function cargarGaleriaNegocio() {
      const negocioId = document.getElementById('negocioGaleriaSelect').value
      if (!negocioId) return

      const { data } = await supabase
        .from('fotos_negocios')
        .select('*')
        .eq('negocio_id', negocioId)
        .order('orden')

      const grid = document.getElementById('galeriaActualGrid')
      if (!data || data.length === 0) {
        grid.innerHTML = '<p class="col-span-full text-center text-gray-500">No hay fotos en la galer√≠a</p>'
        return
      }

      grid.innerHTML = data.map(f => `
        <div class="relative group">
          <img src="${f.url_foto}" class="w-full h-32 object-cover rounded-lg">
          ${f.es_portada ? '<span class="absolute top-2 left-2 bg-yellow-400 text-xs px-2 py-1 rounded font-bold">PORTADA</span>' : ''}
          <button onclick="eliminarFotoGaleria(${f.id})" class="absolute top-2 right-2 bg-red-500 text-white w-8 h-8 rounded-full opacity-0 group-hover:opacity-100 transition">√ó</button>
        </div>
      `).join('')
    }

    async function eliminarFotoGaleria(fotoId) {
      if (!confirm('¬øEliminar esta foto?')) return
      
      const { error } = await supabase.from('fotos_negocios').delete().eq('id', fotoId)
      if (error) return mostrarMensaje('Error: ' + error.message, 'error')
      
      mostrarMensaje('Foto eliminada', 'success')
      await cargarGaleriaNegocio()
    }
  </script>
</body>
</html>